<!DOCTYPE html>





<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="generator" content="Hexo 3.9.0">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.3.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    search: {
      root: '/',
      path: ''
    },
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>

  <meta name="description" content="技术、摄影">
<meta property="og:type" content="website">
<meta property="og:title" content="Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="技术、摄影">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Blog">
<meta name="twitter:description" content="技术、摄影">
  <link rel="canonical" href="http://yoursite.com/">


<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Blog</title>
  








  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  <div class="container sidebar-position-left page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">一日看尽长安花</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
    <ul id="menu" class="menu">
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
    </ul>
</nav>

</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/11/Kubernetes-集群部署-Mysql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Amin">
      <meta itemprop="description" content="技术、摄影">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/11/11/Kubernetes-集群部署-Mysql/" class="post-title-link" itemprop="url">未命名</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-11-11 10:50:55" itemprop="dateCreated datePublished" datetime="2019-11-11T10:50:55+08:00">2019-11-11</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-11-10 19:36:42" itemprop="dateModified" datetime="2019-11-10T19:36:42+08:00">2019-11-10</time>
              </span>
            
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="Kubernetes-集群部署-Mysql"><a href="#Kubernetes-集群部署-Mysql" class="headerlink" title="Kubernetes 集群部署 Mysql"></a>Kubernetes 集群部署 Mysql</h2><h3 id="Mysql-常用命令"><a href="#Mysql-常用命令" class="headerlink" title="Mysql 常用命令"></a>Mysql 常用命令</h3><hr>
<h5 id="查询用户详细信息"><a href="#查询用户详细信息" class="headerlink" title="查询用户详细信息"></a>查询用户详细信息</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> mysql;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">user</span>,authentication_string,host <span class="keyword">from</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure>

<h5 id="查询表结构信息"><a href="#查询表结构信息" class="headerlink" title="查询表结构信息"></a>查询表结构信息</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">**表结构，字段类型，主键，是否为空等属性**</span><br><span class="line">desc tabl_name;</span><br><span class="line"></span><br><span class="line">**查询注释信息**</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> information_schema.</span><br><span class="line"><span class="keyword">where</span> table_schema = <span class="string">'db'</span>  <span class="comment">#表所在数据库</span></span><br><span class="line"><span class="keyword">and</span> table_name = <span class="string">'tablename'</span> ; <span class="comment">#你要查的表</span></span><br></pre></td></tr></table></figure>

<h5 id="查看表生成的DDL"><a href="#查看表生成的DDL" class="headerlink" title="查看表生成的DDL"></a>查看表生成的DDL</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> table_name;</span><br></pre></td></tr></table></figure>

<h5 id="Mysql-新建用户及赋权"><a href="#Mysql-新建用户及赋权" class="headerlink" title="Mysql 新建用户及赋权"></a>Mysql 新建用户及赋权</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">**创建用户**</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'operator'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'password'</span>;</span><br><span class="line">**删除用户**</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> <span class="string">'username'</span>@<span class="string">'host'</span>;</span><br><span class="line"></span><br><span class="line">**授权**</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">privileges</span> <span class="keyword">ON</span> databasename.tablename <span class="keyword">TO</span> <span class="string">'username'</span>@<span class="string">'host'</span></span><br><span class="line">**例子**</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span> <span class="keyword">ON</span> test.user <span class="keyword">TO</span> <span class="string">'operator'</span>@<span class="string">'%'</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'operator'</span>@<span class="string">'%'</span>;</span><br></pre></td></tr></table></figure>

<h5 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">user</span> <span class="string">'operator'</span>@<span class="string">'localhost'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'password'</span>；</span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br></pre></td></tr></table></figure>

<h3 id="部署-Mysql"><a href="#部署-Mysql" class="headerlink" title="部署 Mysql"></a>部署 Mysql</h3><hr>
<p>部署 Mysql 到 Kubernetes 集群中需要使用到 persistent volumes ，来持久化存储数据库相关数据。</p>
<p>此次使用 master 节点的 nfs 目录作为持久化存储的介质，首先在master节点启动 nfs-server 服务。</p>
<h4 id="NFS-安装与配置"><a href="#NFS-安装与配置" class="headerlink" title="NFS 安装与配置"></a>NFS 安装与配置</h4><hr>
<h5 id="NFS-简介"><a href="#NFS-简介" class="headerlink" title="NFS 简介"></a>NFS 简介</h5><p>NFS（Network File System）即网络文件系统，它允许网络中的计算机之间通过TCP/IP网络共享资源。在NFS的应用中，本地NFS的客户端应用可以透明地读写位于远端NFS服务器上的文件，就像访问本地文件一样。</p>
<h5 id="NFS-与-RPC-服务"><a href="#NFS-与-RPC-服务" class="headerlink" title="NFS 与 RPC 服务"></a>NFS 与 RPC 服务</h5><p>RPC（NFS服务需要依赖RPC服务，这个比较重要） 要想了解NFS，必然要提到RPC这个服务。 因为NFS支持的功能还是比较多的，并且不同的功能都会使用不同的程序来启动。每启动一个功能就会启用一些端口来传输数据，因此NFS的功能所对应的端口才没有固定，而是采用随机取用一些未被使用的小于1024的端口来作为传输之用。但如此一来又造成客户端要连接服务器时的困扰，因为客户端要知道服务器端的相关端口才能够联机，此时我们需要远程过程调用（RPC）的服务。 RPC最主要的功能就是指定每个NFS功能所对应的端口号，并且回报给客户端，让客户端可以连接到正确的端口上。当服务器在启动NFS时会随机选用数个端口，并主动地向RPC注册。因此RPC可以知道每个端口对应的NFS功能。然后RPC固定使用端口111来监听客户端的请求并回报客户端正确的端口，所以可以让NFS的启动更为容易。 注意，启动NFS之前，要先启动RPC服务；否则NFS无法向RPC注册。另外，重新启动RPC时原本注册的数据会不见，因此RPC重新启动后它管理的所有程序都需要重新启动以重新向RPC注册，比如NFS服务。</p>
<p>RPC服务作为NFS服务器与NFS客户端的中间接口。</p>
<h5 id="NFS-工作流程"><a href="#NFS-工作流程" class="headerlink" title="NFS 工作流程"></a>NFS 工作流程</h5><p>1、由程序在NFS客户端发起存取文件的请求，客户端本地的RPC(rpcbind)服务会通过网络向NFS服务端的RPC的111端口发出文件存取功能的请求。</p>
<p>2、NFS服务端的RPC找到对应已注册的NFS端口，通知客户端RPC服务。</p>
<p>3、客户端获取正确的端口，并与NFS daemon联机存取数据。</p>
<p>4、存取数据成功后，返回前端访问程序，完成一次存取操作。</p>
<h5 id="nfs-server-安装"><a href="#nfs-server-安装" class="headerlink" title="nfs-server 安装"></a>nfs-server 安装</h5><p><em>注：暂时不要启动nfs-server， 等下面固定好nfs服务端口后再启动，可以避免重启系统</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y rpcbind nfs-utils</span><br><span class="line"></span><br><span class="line">**开机启动**</span><br><span class="line">systemctl enable rpcbind</span><br><span class="line">systemctl enable nfs-server</span><br></pre></td></tr></table></figure>

<p>查看nfs服务向rpc注册的端口信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpcinfo -p</span><br></pre></td></tr></table></figure>

<h5 id="固定nfs服务端口"><a href="#固定nfs服务端口" class="headerlink" title="固定nfs服务端口"></a>固定nfs服务端口</h5><p>我们需要在/etc/sysconfig/nfs 指定特定的端口，这样每次启动nfs 时，相关服务启动的端口就会固定，这样便于我们设置防火墙策略。</p>
<p>修改/etc/sysconfig/nfs文件，将下列内容的注释去掉，如果没有则添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Port rpc.mountd should listen on.</span><br><span class="line">MOUNTD_PORT=892</span><br><span class="line">#</span><br><span class="line"># Optional arguments passed to rpc.statd. See rpc.statd(8)</span><br><span class="line">STATDARG=&quot;&quot;</span><br><span class="line"># Port rpc.statd should listen on.</span><br><span class="line">STATD_PORT=662</span><br><span class="line"># Outgoing port statd should used. The default is port</span><br><span class="line"># is random</span><br><span class="line">STATD_OUTGOING_PORT=2020</span><br></pre></td></tr></table></figure>

<p><strong>vim /etc/modprobe.d/lockd.conf</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Set the TCP port that the NFS lock manager should use.</span><br><span class="line"># port must be a valid TCP port value (1-65535).</span><br><span class="line">options lockd nlm_tcpport=32803</span><br><span class="line">#</span><br><span class="line"># Set the UDP port that the NFS lock manager should use.</span><br><span class="line"># port must be a valid UDP port value (1-65535).</span><br><span class="line">options lockd nlm_udpport=32769</span><br></pre></td></tr></table></figure>

<p>固定服务端口之后，启动nfs-server服务，后执行<code>rpcinfo -p</code>命令，查看nfs向rpc注册的端口。</p>
<h5 id="设置防火墙"><a href="#设置防火墙" class="headerlink" title="设置防火墙"></a>设置防火墙</h5><p>编辑防火墙配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/lib/firewalld/services/nfs.xml /etc/firewalld/services/</span><br></pre></td></tr></table></figure>

<p>文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;service&gt;</span><br><span class="line">  &lt;short&gt;NFS4&lt;/short&gt;</span><br><span class="line">  &lt;description&gt;The NFS4 protocol is used to share files via TCP networking. You will need to have the NFS tools installed and properly configure your NFS server for this option to be useful.&lt;/description&gt;</span><br><span class="line">  &lt;port protocol=&quot;tcp&quot; port=&quot;111&quot;/&gt;</span><br><span class="line">  &lt;port protocol=&quot;tcp&quot; port=&quot;662&quot;/&gt;</span><br><span class="line">  &lt;port protocol=&quot;tcp&quot; port=&quot;892&quot;/&gt;</span><br><span class="line">  &lt;port protocol=&quot;tcp&quot; port=&quot;2049&quot;/&gt;</span><br><span class="line">  &lt;port protocol=&quot;tcp&quot; port=&quot;32803&quot;/&gt;</span><br><span class="line">  &lt;port protocol=&quot;udp&quot; port=&quot;111&quot;/&gt;</span><br><span class="line">  &lt;port protocol=&quot;udp&quot; port=&quot;662&quot;/&gt;</span><br><span class="line">  &lt;port protocol=&quot;udp&quot; port=&quot;892&quot;/&gt;</span><br><span class="line">  &lt;port protocol=&quot;udp&quot; port=&quot;2049&quot;/&gt;</span><br><span class="line">  &lt;port protocol=&quot;udp&quot; port=&quot;32769&quot;/&gt;</span><br><span class="line">&lt;/service&gt;</span><br></pre></td></tr></table></figure>

<p>开启相应端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --zone=public --add-service=nfs</span><br><span class="line"></span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h5 id="server-端创建共享目录"><a href="#server-端创建共享目录" class="headerlink" title="server 端创建共享目录"></a>server 端创建共享目录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/exports</span><br><span class="line"></span><br><span class="line">**允许root用户及其他用户**</span><br><span class="line">[目录] 172.10.10.0/24(rw,sync,no_root_squash,no_root_squash,no_all_squash)</span><br><span class="line"></span><br><span class="line">**压缩用户为nfsnobody**</span><br><span class="line">[目录] 172.10.10.0/24(rw,sync,root_squash,all_squash,anonuid=1001,anongid=1001)</span><br></pre></td></tr></table></figure>

<p>重启nfs-server</p>
<p>查看服务端共享目录情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showmount -e serverIP</span><br></pre></td></tr></table></figure>

<h5 id="客户端挂载"><a href="#客户端挂载" class="headerlink" title="客户端挂载"></a>客户端挂载</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t nfs  serverIP:[服务端共享目录] [本地目录]</span><br></pre></td></tr></table></figure>

<h4 id="Kubernetes-集群持久化存储"><a href="#Kubernetes-集群持久化存储" class="headerlink" title="Kubernetes 集群持久化存储"></a>Kubernetes 集群持久化存储</h4><h5 id="PV-与-PV-claim"><a href="#PV-与-PV-claim" class="headerlink" title="PV 与 PV-claim"></a>PV 与 PV-claim</h5><p>Mysql 挂载两个目录：</p>
<p>数据库数据目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[nfs-server] /data/volumes/mysql-pv/data        [container] /var/lib/mysql</span><br></pre></td></tr></table></figure>

<p>数据库配置目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[nfs-server] /data/volumes/mysql-pv/conf        [container] /etc/mysql/conf.d</span><br></pre></td></tr></table></figure>

<p><strong>yaml 资源定义文件 mysql-pv-volume&amp;claim.yaml</strong></p>
<p>分别定义了两个 pv 与 pv-claim ，pv-claim 与 pv 是一一对应的关系。 </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mysql-pv-data</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    pv:</span> <span class="string">mysql-pv-data</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">5</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/data/volumes/mysql-pv/data</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">10.100</span><span class="number">.100</span><span class="number">.91</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mysql-pv-data-claim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">5</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      pv:</span> <span class="string">mysql-pv-data</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mysql-pv-conf</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    pv:</span> <span class="string">mysql-pv-conf</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/data/volumes/mysql-pv/conf</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">10.100</span><span class="number">.100</span><span class="number">.91</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mysql-pv-conf-claim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      pv:</span> <span class="string">mysql-pv-conf</span></span><br></pre></td></tr></table></figure>

<p>数据持久化的下一步只需要在 deployment 资源定义中 对容器目录进行挂载就可以。</p>
<h4 id="MySQL-部署"><a href="#MySQL-部署" class="headerlink" title="MySQL 部署"></a>MySQL 部署</h4><h5 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h5><p>Deployment 文件 mysql-dep.yaml ，pods 将调度到具有 mysql-dep=allow 标签的节点上。  </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mysql-dep</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">mysql-dep</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">mysql-dep</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">mysql-dep</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - image:</span> <span class="attr">mysql:5.7</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">mysql-dep</span></span><br><span class="line"><span class="attr">        args:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">"--ignore-db-dir=lost+found"</span> </span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            secretKeyRef:</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">mysql-secret</span></span><br><span class="line"><span class="attr">              key:</span> <span class="string">mysql-root-password</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MYSQL_PASSWORD</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            secretKeyRef:</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">mysql-secret</span></span><br><span class="line"><span class="attr">              key:</span> <span class="string">mysql-password</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">mysql-persistent-storage-data</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">mysql-persistent-storage-conf</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/mysql/conf.d</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">mysql-persistent-storage-data</span></span><br><span class="line"><span class="attr">        persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">          claimName:</span> <span class="string">mysql-pv-data-claim</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">mysql-persistent-storage-conf</span></span><br><span class="line"><span class="attr">        persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">          claimName:</span> <span class="string">mysql-pv-conf-claim</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line"><span class="attr">        mysql-dep:</span> <span class="string">allow</span></span><br></pre></td></tr></table></figure>

<p>在deployment中引用了 secret 对环境变量 MYSQL_ROOT_PASSWORD 和 MYSQL_PASSWORD 赋值。</p>
<p>这个部署方式存在环境变量无效的情况（数据库登录失败的问题），后面我们会详细介绍如何解决。</p>
<h5 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h5><p>创建 Secret  mysql-secret.yaml 密码部分使用 bsae64 编码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">**base64 编码**</span><br><span class="line">echo &apos;123456&apos; | base64</span><br><span class="line"></span><br><span class="line">**base64 解码**</span><br><span class="line">echo &apos;MTIzNDU2Cg==&apos; | base64 -d</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mysql-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  mysql-root-password:</span> <span class="string">MTIzNDU2Cg==</span></span><br><span class="line"><span class="attr">  mysql-password:</span> <span class="string">MTIzNDU2Cg==</span></span><br></pre></td></tr></table></figure>

<h5 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h5><p>Mysql service 服务 mysql-svc.yaml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mysql-svc</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">mysql-dep</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">mysql-dep</span></span><br></pre></td></tr></table></figure>

<h5 id="Mysql-配置"><a href="#Mysql-配置" class="headerlink" title="Mysql 配置"></a>Mysql 配置</h5><p>部署完成后可以在集群中通过临时 pod 来访问 Mysql。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run -it --rm --image=mysql:5.6 --restart=Never mysql-client -- mysql -h mysql-svc -uroot -ppassword</span><br></pre></td></tr></table></figure>

<p>此时会发现登录认证失败的问题。原因就是上面提到的环境变量 MYSQL_ROOT_PASSWORD 和 MYSQL_PASSWORD 无效导致的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1045 (28000): Access denied for user &apos;operator&apos;@&apos;10.244.0.91&apos; (using password: YES)</span><br></pre></td></tr></table></figure>

<p>需要修改配置文件 my.cnf 添加 skip-grant-tables 参数来跳过登录验证，重置 root 密码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">skip-grant-tables</span><br></pre></td></tr></table></figure>

<p>修改完配置文件后，到 Mysql pod 所在的 node 节点，重启 mysql 容器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker ps | grep mysql</span><br><span class="line"></span><br><span class="line">024e80cfff80        cd3ed0dfff7e           &quot;docker-entrypoint.s…&quot;   11 hours ago        Up 10 hours                             k8s_mysql-dep_mysql-dep-7878b9c59b-hrzmc_default_5a381927-4503-43a7-babe-c3456c16b4c7_1</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# docker restart 024e80cfff80</span><br></pre></td></tr></table></figure>

<p>也可直接进入 mysql 容器本地登录 mysql。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker exec -it  024e80cfff80 bash</span><br><span class="line"></span><br><span class="line">root@mysql-dep-7878b9c59b-hrzmc:/# mysql -uroot -p</span><br></pre></td></tr></table></figure>

<p><strong>修改mysql root用户密码</strong></p>
<p>登录进 mysql 之后，将 root 密码置空。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use mysql;</span><br><span class="line"></span><br><span class="line">select user,authentication_string,host from user;</span><br><span class="line"></span><br><span class="line">update user set authentication_string=&apos;&apos; where user=&apos;root&apos;;</span><br><span class="line"></span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<p>然后退出 mysql，将 my.cnf 文件中 skip-grant-tables 参数注释掉，重启mysql容器。之后即可正常登录 mysql。</p>
<p>修改密码及授权。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alter user &apos;root&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;password&apos;；</span><br><span class="line"></span><br><span class="line">GRANT ALL ON *.* TO &apos;root&apos;@&apos;localhost&apos;;</span><br><span class="line"></span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<p><strong>附 my.cnf 配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html</span><br><span class="line">#</span><br><span class="line"># [client]</span><br><span class="line">default-character-set=utf8</span><br><span class="line">#</span><br><span class="line"># [mysql]</span><br><span class="line">default-character-set=utf8</span><br><span class="line">#</span><br><span class="line"># [mysqld]</span><br><span class="line"># skip-grant-tables</span><br><span class="line"></span><br><span class="line"># # Remove leading # and set to the amount of RAM for the most important data</span><br><span class="line"># # cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.</span><br><span class="line"># # innodb_buffer_pool_size = 128M</span><br><span class="line"># #</span><br><span class="line"># # Remove leading # to turn on a very important data integrity option: logging</span><br><span class="line"># # changes to the binary log between backups.</span><br><span class="line"># # log_bin</span><br><span class="line"># #</span><br><span class="line"># # Remove leading # to set options mainly useful for reporting servers.</span><br><span class="line"># # The server defaults are faster for transactions and fast SELECTs.</span><br><span class="line"># # Adjust sizes as needed, experiment to find the optimal values.</span><br><span class="line"># # join_buffer_size = 128M</span><br><span class="line"># # sort_buffer_size = 2M</span><br><span class="line"># # read_rnd_buffer_size = 2M</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">#</span><br><span class="line"># # Disabling symbolic-links is recommended to prevent assorted security risks</span><br><span class="line">symbolic-links=0</span><br><span class="line"></span><br><span class="line">log-error=/var/lib/mysql/mysqld.log</span><br><span class="line">pid-file=/var/lib/mysql/mysqld.pid</span><br><span class="line">collation-server = utf8_unicode_ci</span><br><span class="line">init-connect=&apos;SET NAMES utf8&apos;</span><br><span class="line">character-set-server = utf8</span><br></pre></td></tr></table></figure>

<p>至此 Mysql 初步部署已完成，后续还需要添加相应的 Ingress 服务。因为是测试所以数据库直接部署在 default namespaces 中，正式环境中还需要定义相应的 RBAC 资源。</p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/29/Prometheus-监控-k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Amin">
      <meta itemprop="description" content="技术、摄影">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/10/29/Prometheus-监控-k8s/" class="post-title-link" itemprop="url">[object Object]</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-10-29 18:06:29" itemprop="dateCreated datePublished" datetime="2019-10-29T18:06:29+08:00">2019-10-29</time>
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            
          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/28/DNS集群压力测试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Amin">
      <meta itemprop="description" content="技术、摄影">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/10/28/DNS集群压力测试/" class="post-title-link" itemprop="url">未命名</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-10-28 15:19:22 / 修改时间：18:56:47" itemprop="dateCreated datePublished" datetime="2019-10-28T15:19:22+08:00">2019-10-28</time>
            </span>
          
            

            
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <hr>
<p>title:DNS集群压力测试<br>date:2019-10-28<br>tags:DNS</p>
<h2 id="categories-DNS"><a href="#categories-DNS" class="headerlink" title="categories:DNS"></a>categories:DNS</h2><h3 id="DNS服务压力测试"><a href="#DNS服务压力测试" class="headerlink" title="DNS服务压力测试"></a>DNS服务压力测试</h3><h4 id="安装queryperf"><a href="#安装queryperf" class="headerlink" title="安装queryperf"></a>安装queryperf</h4><p>queryperf编译好之后，可以直接二进制使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://ftp.isc.org/isc/bind9/9.7.3/bind-9.7.3.tar.gz</span><br><span class="line">tar xf bind-9.7.3.tar.gz</span><br><span class="line">cd /usr/local/src/bind-9.7.3/contrib/queryperf</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">cp queryperf /usr/bin/</span><br></pre></td></tr></table></figure>

<h4 id="queryperf使用"><a href="#queryperf使用" class="headerlink" title="queryperf使用"></a>queryperf使用</h4><p>在dns_test.txt文件中写入要查询的域名记录，使用 yy1000p 复制1000行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">baidu.com A</span><br></pre></td></tr></table></figure>

<p>测试命令及输出结果</p>
<p>一共查询 10 万条 A 记录，QPS ：13946</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queryperf -d dns_test.txt -s dns_server_address</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/28/DNS集群压力测试/91dc68d729f635f7fc9dd4ccce022d6.png" alt="DNS压力测试结果"></p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/22/高可用DNS服务集群/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Amin">
      <meta itemprop="description" content="技术、摄影">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/10/22/高可用DNS服务集群/" class="post-title-link" itemprop="url">[object Object]</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-10-22 16:53:15 / 修改时间：18:15:10" itemprop="dateCreated datePublished" datetime="2019-10-22T16:53:15+08:00">2019-10-22</time>
            </span>
          
            

            
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h3 id="高可用DNS服务集群部署"><a href="#高可用DNS服务集群部署" class="headerlink" title="高可用DNS服务集群部署"></a>高可用DNS服务集群部署</h3><h4 id="一、部署方案"><a href="#一、部署方案" class="headerlink" title="一、部署方案"></a>一、部署方案</h4><p>现需要在公司内部署一套高可用DNS服务，对指定域名做本地解析，其他域名解析请求做转发。将采用keepalived+Bind来实现高可用主从同步DNS服务。采用keepalived和两台主从DNS服务器提供服务，拓扑图如下：</p>
<p>DNS集群中Master负责下发数据。</p>
<p>当Master与Slave节点均正常运行时，Master负责提供服务，Slave作为备份；当Master宕机时，Slave接管服务。</p>
<p><img src="/2019/10/22/高可用DNS服务集群/%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88.png" alt="部署方案"></p>
<h4 id="二、扩展方案"><a href="#二、扩展方案" class="headerlink" title="二、扩展方案"></a>二、扩展方案</h4><p>若后续服务能力不足需要扩展，可以使用LVS+keepalived提供前置负载均衡，后端DNS服务集群做水平扩展，方案如下：</p>
<p><img src="/2019/10/22/高可用DNS服务集群/%E6%89%A9%E5%B1%95%E6%96%B9%E6%A1%88.png" alt="扩展方案"></p>
<hr>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/03/Grafana-安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Amin">
      <meta itemprop="description" content="技术、摄影">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/09/03/Grafana-安装/" class="post-title-link" itemprop="url">Grafana 初探</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-09-03 17:01:38 / 修改时间：19:28:15" itemprop="dateCreated datePublished" datetime="2019-09-03T17:01:38+08:00">2019-09-03</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Grafana/" itemprop="url" rel="index"><span itemprop="name">Grafana</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h3 id="Grafana-安装"><a href="#Grafana-安装" class="headerlink" title="Grafana 安装"></a>Grafana 安装</h3><hr>
<p><em>官网 <a href="https://grafana.com/docs/" target="_blank" rel="noopener">https://grafana.com/docs/</a></em></p>
<h4 id="Centos-上-RPM-安装-Grafana"><a href="#Centos-上-RPM-安装-Grafana" class="headerlink" title="Centos 上 RPM 安装 Grafana"></a>Centos 上 RPM 安装 Grafana</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.grafana.com/oss/release/grafana-6.3.5-1.x86_64.rpm</span><br><span class="line">yum install initscripts urw-fonts</span><br><span class="line">rpm -Uvh grafana-6.3.5-1.x86_64.rpm</span><br></pre></td></tr></table></figure>


          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/15/Python 与 Mysql 数据库交互/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Amin">
      <meta itemprop="description" content="技术、摄影">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/15/Python 与 Mysql 数据库交互/" class="post-title-link" itemprop="url">Python 与 Mysql 数据库交互</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-15 00:00:00 / 修改时间：13:23:09" itemprop="dateCreated datePublished" datetime="2019-08-15T00:00:00+08:00">2019-08-15</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h3 id="Python-与-Mysql-数据库交互"><a href="#Python-与-Mysql-数据库交互" class="headerlink" title="Python 与 Mysql 数据库交互"></a>Python 与 Mysql 数据库交互</h3><h5 id="使用pymsql-将-Dataframe-数据写入到MySQL库，使用-itertuples-迭代器以-tuple-取出每一行的数据"><a href="#使用pymsql-将-Dataframe-数据写入到MySQL库，使用-itertuples-迭代器以-tuple-取出每一行的数据" class="headerlink" title="使用pymsql 将 Dataframe 数据写入到MySQL库，使用 itertuples 迭代器以 tuple 取出每一行的数据"></a>使用pymsql 将 Dataframe 数据写入到MySQL库，使用 itertuples 迭代器以 tuple 取出每一行的数据</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">time_start = time.time()</span><br><span class="line">con = pymysql.connect(host=<span class="string">'IP'</span>,port=<span class="number">3306</span>,user=<span class="string">'userName'</span>,password=<span class="string">'Password'</span>,database=<span class="string">'databaseName'</span>,charset=<span class="string">'utf8mb4'</span>)</span><br><span class="line">cur = con.cursor()</span><br><span class="line">df = df.fillna(<span class="string">'NULL'</span>)</span><br><span class="line">data_list = []</span><br><span class="line"><span class="comment">#使用 itertuples 迭代器以 tuple 取出每一行的数据，拼接为list</span></span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> df.itertuples(index=<span class="literal">False</span>,name=<span class="literal">None</span>):</span><br><span class="line">    data_list.append(row)</span><br><span class="line"></span><br><span class="line">sql = <span class="string">'INSERT IGNORE INTO neZha_maoyan_comment(nickName,cityName,gender,content,score,userLevel,startTime) values(%s,%s,%s,%s,%s,%s,%s)'</span></span><br><span class="line">cur.execute(sql,data_list)</span><br><span class="line"><span class="comment">#写入要提交数据（事务）否则数据不会保存</span></span><br><span class="line">con.commit()</span><br><span class="line">cur.close()</span><br><span class="line">con.close()</span><br><span class="line">print(time.time()-time_start)</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/12/Mysql 常用命令/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Amin">
      <meta itemprop="description" content="技术、摄影">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/12/Mysql 常用命令/" class="post-title-link" itemprop="url">Mysql 常用命令</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-12 00:00:00" itemprop="dateCreated datePublished" datetime="2019-08-12T00:00:00+08:00">2019-08-12</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-09-03 18:18:21" itemprop="dateModified" datetime="2019-09-03T18:18:21+08:00">2019-09-03</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Mysql/" itemprop="url" rel="index"><span itemprop="name">Mysql</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Mysql-常用命令"><a href="#Mysql-常用命令" class="headerlink" title="Mysql 常用命令"></a>Mysql 常用命令</h3><hr>
<h4 id="表结构信息"><a href="#表结构信息" class="headerlink" title="表结构信息"></a>表结构信息</h4><p><strong>查询表中注释信息</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> information_schema.columns</span><br><span class="line"><span class="keyword">where</span> table_schema = <span class="string">'dbName'</span> <span class="comment">#表所在数据库</span></span><br><span class="line"><span class="keyword">and</span> table_name = <span class="string">'tableName'</span> ; <span class="comment">#你要查的表</span></span><br></pre></td></tr></table></figure>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2019/08/12/Mysql 常用命令/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/11/上海堡垒是烂片吗？数据一览/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Amin">
      <meta itemprop="description" content="技术、摄影">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/11/上海堡垒是烂片吗？数据一览/" class="post-title-link" itemprop="url">上海堡垒是烂片吗？数据一览</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-11 21:01:38" itemprop="dateCreated datePublished" datetime="2019-08-11T21:01:38+08:00">2019-08-11</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-10-17 09:33:47" itemprop="dateModified" datetime="2019-10-17T09:33:47+08:00">2019-10-17</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/电影/" itemprop="url" rel="index"><span itemprop="name">电影</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="上海堡垒是烂片吗？数据一览"><a href="#上海堡垒是烂片吗？数据一览" class="headerlink" title="上海堡垒是烂片吗？数据一览"></a>上海堡垒是烂片吗？数据一览</h3><hr>
<p>《上海堡垒》于2019年8月9日上映，上映之后口碑一路走低。猫眼评论区充斥着半星及一星评分，猫眼都这种评价毫无疑问是烂片了，在微博上也都在疯狂吐槽这部电影。空口无凭，让我们通过数据看看网友们都是怎样评价这部电影的。开始之前我们先观摩一番电影海报，如下。</p>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2019/08/11/上海堡垒是烂片吗？数据一览/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/10/Python3安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Amin">
      <meta itemprop="description" content="技术、摄影">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/10/Python3安装/" class="post-title-link" itemprop="url">安装python3</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-10 11:01:38" itemprop="dateCreated datePublished" datetime="2019-08-10T11:01:38+08:00">2019-08-10</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-09-02 13:18:43" itemprop="dateModified" datetime="2019-09-02T13:18:43+08:00">2019-09-02</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="安装python3"><a href="#安装python3" class="headerlink" title="安装python3"></a>安装python3</h3><h4 id="以安装python3-6-6为例"><a href="#以安装python3-6-6为例" class="headerlink" title="以安装python3.6.6为例"></a>以安装python3.6.6为例</h4><p><em>安装包地址 <a href="https://www.python.org/ftp/python/" target="_blank" rel="noopener">https://www.python.org/ftp/python/</a></em></p>
<p><strong>安装必要组件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel libffi-devel gcc make</span><br></pre></td></tr></table></figure>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2019/08/10/Python3安装/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/10/Mysql 主键约束、唯一约束、联合唯一约束、非空约束、外键约束/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Amin">
      <meta itemprop="description" content="技术、摄影">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/10/Mysql 主键约束、唯一约束、联合唯一约束、非空约束、外键约束/" class="post-title-link" itemprop="url">Mysql 主键约束、唯一约束、联合唯一约束、非空约束、外键约束</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-10 00:00:00" itemprop="dateCreated datePublished" datetime="2019-08-10T00:00:00+08:00">2019-08-10</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-15 13:25:51" itemprop="dateModified" datetime="2019-08-15T13:25:51+08:00">2019-08-15</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Mysql/" itemprop="url" rel="index"><span itemprop="name">Mysql</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Mysql-主键约束、唯一约束、联合唯一约束、非空约束、外键约束"><a href="#Mysql-主键约束、唯一约束、联合唯一约束、非空约束、外键约束" class="headerlink" title="Mysql 主键约束、唯一约束、联合唯一约束、非空约束、外键约束"></a>Mysql 主键约束、唯一约束、联合唯一约束、非空约束、外键约束</h3><h4 id="主键约束-PRIMARY-KEY"><a href="#主键约束-PRIMARY-KEY" class="headerlink" title="主键约束 PRIMARY KEY"></a>主键约束 PRIMARY KEY</h4><p>PRIMARY KEY 主键是唯一的，一张表只能有一个主键</p>
<p>主键可以由多个字段组合而成（字段越少越好），多个字段时复合主键形成唯一索引</p>
<p>主键不允许为空</p>
<blockquote>
<p>在创建表时，添加主键约束</p>
<p>自动增长：如果某一列是数值类型的，使用 auto_increment 可以来完成值得自动增长</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; create table stu(</span><br><span class="line">&gt; 	Id int(11) NOT NULL AUTO_INCREMENT,     --自动增长数值</span><br><span class="line">&gt; 	username varchar(20) NOT NULL unique, </span><br><span class="line">&gt; 	PRIMARY KEY(Id)</span><br><span class="line">&gt; );</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>删除自动增长</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; ALTER TABLE stu MODIFY Id int(11) NOT NULL;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>添加自动增长</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; ALTER TABLE stu MODIFY Id int(11) NOT NULL AUTO_INCREMENT;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>删除主键</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; ALTER TABLE stu DROP PRIMARY KEY;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>创建完表后添加主键</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; ALTER TABLE stu MODIFY Id int(11) NOT NULL PRIMARY KEY;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2019/08/10/Mysql 主键约束、唯一约束、联合唯一约束、非空约束、外键约束/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Amin</p>
  <div class="site-description motion-element" itemprop="description">技术、摄影</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>



        </div>
      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Amin</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.3.0</div>

        








        
      </div>
    </footer>
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
      </div>

    

  </div>

  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  <script src="/js/utils.js?v=7.3.0"></script>
  <script src="/js/motion.js?v=7.3.0"></script>

  
  <script src="/js/affix.js?v=7.3.0"></script>
  <script src="/js/schemes/pisces.js?v=7.3.0"></script>


  

  <script src="/js/next-boot.js?v=7.3.0"></script>

  

  

  


  




































</body>
</html>
